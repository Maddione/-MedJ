{% extends "basetemplates/base.html" %}
{% load static i18n %}

{% block nav_buttons %}
<div class="flex items-center gap-2 md:gap-6">
  {% with request.resolver_match.url_name as url_name %}
  <a href="{% url 'medj:dashboard' %}" class="px-3 md:px-5 py-2 font-bold uppercase tracking-wide rounded-full transition-colors {% if url_name == 'dashboard' %}bg-blockbg text-primaryDark shadow-md{% else %}text-white hover:bg-white/20{% endif %}">{% trans "Табло" %}</a>
  <a href="{% url 'medj:casefiles' %}" class="px-3 md:px-5 py-2 font-bold uppercase tracking-wide rounded-full transition-colors {% if url_name == 'casefiles' or 'medical_event' in url_name %}bg-blockbg text-primaryDark shadow-md{% else %}text-white hover:bg-white/20{% endif %}">{% trans "Досие" %}</a>
  <a href="{% url 'medj:personalcard' %}" class="px-3 md:px-5 py-2 font-bold uppercase tracking-wide rounded-full transition-colors {% if url_name == 'personalcard' %}bg-blockbg text-primaryDark shadow-md{% else %}text-white hover:bg-white/20{% endif %}">{% trans "Л.Картон" %}</a>
  <a href="{% url 'medj:documents' %}" class="px-3 md:px-5 py-2 font-bold uppercase tracking-wide rounded-full transition-colors {% if url_name == 'documents' or 'document_' in url_name %}bg-blockbg text-primaryDark shadow-md{% else %}text-white hover:bg-white/20{% endif %}">{% trans "Документи" %}</a>
  {% endwith %}
</div>
{% endblock %}

{% block nav_user %}
{% if user.is_authenticated %}
<div class="flex items-center gap-3">
  <a href="{% url 'medj:upload' %}" class="px-4 py-2 rounded-xl font-semibold text-white" style="background:#0A4E75">{% trans "Качи" %}</a>
  <a href="{% url 'medj:share' %}" class="px-4 py-2 rounded-xl font-semibold text-white" style="background:#15BC11">{% trans "Сподели" %}</a>
  <span class="text-white font-semibold truncate max-w-[12rem] md:max-w-[16rem]">
    {{ user.get_full_name|default:user.username }}
  </span>
  <div class="relative" id="userMenuWrap">
    <button id="userMenuBtn" class="flex items-center justify-center p-2">
      <img src="{% static 'images/profileicon.png' %}" alt="profile" class="h-7 w-7">
    </button>
    <div id="userMenu" class="hidden absolute top-full right-0 mt-2 w-64 z-50 rounded-xl shadow-lg bg-white p-2">
      <div class="px-3 py-2 text-sm text-gray-700 border-b border-gray-200">
        <p class="font-semibold">{% trans "Профил" %}</p>
        <p class="truncate text-gray-500">{{ user.email|default:user.username }}</p>
      </div>
      <nav class="mt-2 text-primaryDark">
        <a href="{% url 'medj:upload' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg font-semibold">{% trans "Качи документ" %}</a>
        <a href="{% url 'medj:documents' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg">{% trans "История" %}</a>
        <a href="{% url 'medj:share_history_page' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg">{% trans "Споделяния" %}</a>
        <a href="{% url 'medj:doctors' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg">{% trans "Лекари" %}</a>
        <a href="{% url 'medj:labtests' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg">{% trans "Изследвания" %}</a>
        <div class="my-2 border-t border-gray-200"></div>
        <a href="{% url 'medj:profile' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg">{% trans "Настройки" %}</a>
        <a href="{% url 'medj:password_change' %}" class="block px-3 py-2 rounded-lg hover:bg-sitebg">{% trans "Смяна на парола" %}</a>
        <div class="my-2 border-t border-gray-200"></div>
        <form method="post" action="{% url 'medj:logout' %}">
          {% csrf_token %}
          <button class="w-full text-left px-3 py-2 rounded-lg text-red-600 hover:bg-red-50">{% trans "Изход" %}</button>
        </form>
      </nav>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}


{% block body_content %}
<div class="w-[98%] mx-auto bg-blockbg rounded-3xl shadow-md flex-grow p-4 sm:p-6 lg:p-8">
  {% block app_content %}{% endblock %}
</div>

<div id="ob_welcome" class="hidden fixed inset-0 z-50 bg-black/50 p-4">
  <div class="bg-white rounded-2xl w-full max-w-lg mx-auto p-6">
    <h3 class="text-lg font-semibold text-[var(--color-primaryDark)] mb-2">{% trans "Добре дошли!" %}</h3>
    <p class="text-sm mb-4">{% trans "Онбордингът приключи. Вече можете да използвате MedJ пълноценно." %}</p>
    <div class="flex justify-end gap-3">
      <button id="ob4_ok" class="px-4 py-2 rounded-xl bg-[var(--color-primaryDark)] text-white">{% trans "Разбрах" %}</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('userMenuBtn');
  const menu = document.getElementById('userMenu');
  if (btn && menu) {
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      menu.classList.toggle('hidden');
    });
    document.addEventListener('click', function(e){
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });
  }
});
</script>
<script src="{% static 'js/onboarding_tour.js' %}?v={% now 'U' %}"></script>
{% endblock %}
