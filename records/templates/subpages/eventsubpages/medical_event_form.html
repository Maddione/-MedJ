{% extends 'basetemplates/base_app.html' %}
{% load static %}
{% load i18n %}

{% block app_content %}
<main class="bg-site-background min-h-screen p-4 md:p-8">
    <div class="container mx-auto max-w-7xl">
        <div class="bg-block-background p-6 rounded-3xl shadow-lg mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                {% if medical_event %}{% trans "Редакция на медицинско събитие" %}{% else %}{% trans "Създаване на ново медицинско събитие" %}{% endif %}
            </h1>
            <p class="mt-2 text-gray-600">
                {% if medical_event %}{% trans "Редактирайте подробностите за това медицинско събитие." %}{% else %}{% trans "Въведете подробности за новото медицинско събитие." %}{% endif %}
            </p>
        </div>

        <div class="bg-block-background p-6 rounded-3xl shadow-lg">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    {# Лява секция: Визуализация на документа (подобно на upload_review) #}
                    <div class="bg-gray-100 p-4 rounded-lg shadow-inner flex flex-col items-center justify-center min-h-[500px]">
                        <h3 class="text-xl font-bold mb-4" style="color: #0A4E75;">{% trans "Прикачен документ" %}</h3>
                        {% if medical_event.source_document %}
                            {% with file_ext=medical_event.source_document.file.name|slice:"-3:" %}
                                {% if file_ext|lower == 'png' or file_ext|lower == 'jpg' or file_ext|lower == 'peg' or file_ext|lower == 'gif' %}
                                    <img src="{{ medical_event.source_document.file.url }}" alt="{% trans 'Изображение на документ' %}" class="max-w-full h-auto rounded-lg shadow-md border border-gray-300">
                                {% elif file_ext|lower == 'pdf' %}
                                    <iframe src="{{ medical_event.source_document.file.url }}#toolbar=0&navpanes=0&scrollbar=0" width="100%" height="500px" class="rounded-lg shadow-md border border-gray-300" style="border: none;"></iframe>
                                    <p class="text-sm text-gray-500 mt-2">{% trans "Забележка: PDF визуализацията може да изглежда различно в зависимост от браузъра." %}</p>
                                {% else %}
                                    <p class="text-gray-500">{% trans "Няма визуализация за този тип файл." %}</p>
                                {% endif %}
                            {% endwith %}
                            <a href="{{ medical_event.source_document.file.url }}" target="_blank" class="text-button-blue hover:underline font-medium mt-2">{% trans "Преглед в цял размер" %}</a>
                        {% else %}
                            <p class="text-gray-500">{% trans "Няма прикачен документ." %}</p>
                        {% endif %}
                    </div>

                    {# Дясна секция: Форма за редактиране #}
                    <div class="bg-creamy-main-content p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-navbar-button-blue mb-4">{% trans "Детайли на събитието" %}</h3>
                        <div class="space-y-4">
                            {# Поле за пациент (ако не е автоматично зададен) #}
                            {% if not medical_event %}
                            <div>
                                <label for="id_patient" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Пациент" %}</label>
                                {{ form.patient }}
                            </div>
                            {% endif %}
                            
                            <div>
                                <label for="id_event_type_title" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Тип събитие" %}</label>
                                {{ form.event_type_title }}
                            </div>
                            <div>
                                <label for="id_event_date" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Дата на събитието" %}</label>
                                {{ form.event_date }}
                            </div>
                            <div>
                                <label for="id_category" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Категория" %}</label>
                                {{ form.category }}
                            </div>
                            <div>
                                <label for="id_specialty" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Специалност" %}</label>
                                {{ form.specialty }}
                            </div>
                            <div>
                                <label for="id_summary" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Резюме" %}</label>
                                {{ form.summary }}
                            </div>
                            <div>
                                <label for="id_practitioners" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Практикуващи лекари" %}</label>
                                {{ form.practitioners }}
                            </div>
                            <div>
                                <label for="id_tags" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Тагове" %}</label>
                                {{ form.tags }}
                            </div>
                        </div>

                        {% if form.errors %}
                            <div class="bg-light-red-bg border border-error-red text-dark-red-text px-4 py-3 rounded-lg relative mt-6">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="text-center pt-8">
                            <button type="submit" class="px-8 py-4 bg-button-blue text-white font-bold rounded-lg shadow-md hover:bg-navbar-button-blue transition-colors">
                                {% if medical_event %}{% trans "Запази промените" %}{% else %}{% trans "Създай събитие" %}{% endif %}
                            </button>
                            <a href="{% if medical_event %}{% url 'medj:medical_event_detail' pk=medical_event.id %}{% else %}{% url 'medj:medical_event_list' %}{% endif %}" class="ml-4 px-8 py-4 bg-gray-200 text-gray-700 font-bold rounded-lg shadow-md hover:bg-gray-300 transition-colors">
                                {% trans "Отказ" %}
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock %}