{% extends "basetemplates/base_app.html" %}
{% load i18n static %}

{% block title %}{% trans "Табло" %}{% endblock %}

{% block app_content %}
<div class="space-y-6">

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
      {% for c in charts_data %}
      <div class="rounded-2xl p-4 shadow-sm" style="background:#EBEDE0">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold" style="color:#0A1E4A">
            {{ c.name }}{% if c.unit %}, {{ c.unit }}{% endif %}
          </div>
        </div>
        <div class="h-40 bg-white rounded-xl p-2">
          <svg class="w-full h-full" data-series='{{ c.series|safe }}' viewBox="0 0 400 160" preserveAspectRatio="none"></svg>
        </div>
      </div>
      {% empty %}
      <div class="rounded-2xl p-6 shadow-sm sm:col-span-2" style="background:#EBEDE0;color:#0A1E4A">{% trans "Няма достатъчно данни за кръвни показатели." %}</div>
      {% endfor %}
    </div>

    <div class="space-y-6">
      <div class="rounded-2xl p-4 shadow-sm" style="background:#EBEDE0">
        <div class="inline-block px-4 py-2 rounded-lg text-white font-semibold mb-4" style="background:#0A4E75">{% trans "Предстоящи прегледи" %}</div>
        <ul class="space-y-3" style="color:#0A1E4A">
          {% for ev in upcoming_events %}
          <li class="flex justify-between">
            <span>{{ ev.event_date }}</span>
            <span class="font-semibold">{{ ev.title }}</span>
          </li>
          {% empty %}
          <li class="opacity-70">{% trans "Няма насрочени прегледи." %}</li>
          {% endfor %}
        </ul>
      </div>

      <div class="rounded-2xl p-4 shadow-sm" style="background:#EBEDE0">
        <div class="grid grid-cols-3 gap-4 mb-3">
          <div>
            <div class="inline-block px-4 py-2 rounded-lg text-white font-semibold" style="background:#0A4E75">{% trans "Срок" %}</div>
          </div>
          <div class="col-span-2">
            <div class="inline-block px-4 py-2 rounded-lg text-white font-semibold" style="background:#0A4E75">{% trans "Рецепти за изпълнение" %}</div>
          </div>
        </div>
        <div class="space-y-4" style="color:#0A1E4A">
          {% for r in prescriptions %}
          <div class="grid grid-cols-3 gap-4">
            <div>{{ r.created_at }}</div>
            <div class="col-span-2">{{ r.title }}</div>
          </div>
          {% empty %}
          <div class="opacity-70">{% trans "Няма активни рецепти." %}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="rounded-2xl p-5" style="background:#EBEDE0">
    <div class="inline-block px-4 py-2 rounded-lg text-white font-semibold mb-4" style="background:#0A4E75">{% trans "Приемани медикаменти" %}</div>
    <div id="meds-holder" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for m in medications %}
      <div class="rounded-2xl p-4 bg-white border" style="border-color:rgba(10,78,117,.3)">
        <div class="h-28 rounded-lg mb-3" style="background:#FFFFF5"></div>
        <div class="font-semibold mb-1" style="color:#0A1E4A">{{ m.name }}</div>
        <div class="text-sm" style="color:rgba(10,30,74,.8)">{{ m.subtitle }}</div>
      </div>
      {% empty %}
      <div class="opacity-70" style="color:#0A1E4A">{% trans "Няма въведени медикаменти." %}</div>
      {% endfor %}
    </div>
  </div>

</div>
{% endblock %}

{% block scripts_extra %}
{{ block.super }}
<script>
(function(){
  function renderLine(svg, series){
    if(!series || series.length === 0) return;
    const w = 400, h = 160, pad = 12;
    const xs = series.map(p=>new Date(p.x).getTime());
    const ys = series.map(p=>Number(p.y)).filter(v=>isFinite(v));
    const minX = Math.min.apply(null, xs);
    const maxX = Math.max.apply(null, xs);
    const minY = Math.min.apply(null, ys);
    const maxY = Math.max.apply(null, ys);
    const dx = maxX - minX || 1;
    const dy = (maxY - minY) || 1;
    function sx(x){ return pad + (w - 2*pad) * ((x - minX) / dx); }
    function sy(y){ return h - pad - (h - 2*pad) * ((y - minY) / dy); }
    const pts = series.map(p=>`${sx(new Date(p.x).getTime()).toFixed(1)},${sy(Number(p.y)).toFixed(1)}`).join(' ');
    const pl = document.createElementNS('http://www.w3.org/2000/svg','polyline');
    pl.setAttribute('fill','none');
    pl.setAttribute('stroke','#0A4E75');
    pl.setAttribute('stroke-width','3');
    pl.setAttribute('points', pts);
    svg.appendChild(pl);
    for(const p of series){
      const cx = sx(new Date(p.x).getTime());
      const cy = sy(Number(p.y));
      const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx', cx);
      dot.setAttribute('cy', cy);
      dot.setAttribute('r', 3);
      dot.setAttribute('fill', '#0A4E75');
      svg.appendChild(dot);
    }
  }
  document.querySelectorAll('svg[data-series]').forEach(svg=>{
    try{ renderLine(svg, JSON.parse(svg.getAttribute('data-series'))); }catch(e){}
  });
})();
</script>
{% endblock %}
