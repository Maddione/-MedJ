{% extends 'basetemplates/base_app.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "История на документи" %}{% endblock %}
{% block app_content %}
<main class="bg-site-background min-h-screen p-4 md:p-8">
  <div class="container mx-auto max-w-7xl">
    <div class="bg-primaryDark p-6 rounded-3xl shadow-lg mb-8">
      <h1 class="text-2xl font-bold text-blockbg mb-4">{% trans "История на качените документи" %}</h1>
      <p class="mt-2 text-blockbg">{% trans "Преглед на всички документи, които сте качили." %}</p>
    </div>

    <div class="p-6 rounded-3xl shadow-lg" style="background:#FFFFF5">
      <form method="get" class="flex items-center mb-6 gap-3">
        <input type="text" name="q" value="{{ query }}" placeholder="{% trans 'Търсене по име на документ или таг...' %}" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-button-blue focus:border-button-blue" aria-label="{% trans 'Търсене по хеш или име' %}">
        <button type="submit" class="px-4 py-3 bg-button-blue text-primaryDark rounded-lg shadow-sm hover:bg-navbar-button-blue transition-colors">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>

      {% if query %}
      <div class="mb-4 px-4 py-3 rounded-2xl bg-white border border-button-blue/40 text-sm text-primaryDark" role="status">
        {% blocktrans with hash=query %}Филтриране по съдържателен хеш: {{ hash }}{% endblocktrans %}
      </div>
      {% endif %}

      <div class="rounded-2xl p-3" style="background:#EBEDE0">
        <div class="grid grid-cols-12 items-center gap-2 px-2 py-2 rounded-xl" style="background:#0A4E75;color:#fff">
          <div class="col-span-3 font-semibold text-center">{% trans "Дата на качване" %}</div>
          <div class="col-span-3 font-semibold text-center">{% trans "Име на файл" %}</div>
          <div class="col-span-2 font-semibold text-center">{% trans "Тип документ" %}</div>
          <div class="col-span-2 font-semibold text-center">{% trans "Тагове" %}</div>
          <div class="col-span-2 font-semibold text-center">{% trans "Действия" %}</div>
        </div>

        <div class="bg-creamy-main-content rounded-b-2xl divide-y divide-button-blue">
          {% if documents %}
            {% for doc in documents %}
              <div class="grid grid-cols-12 items-center gap-2 px-3 py-3 hover:bg-gray-50">
                <div class="col-span-3 whitespace-nowrap text-center">
                  {{ doc.uploaded_at|date:"d.m.Y H:i" }}
                </div>
                <div class="col-span-3 truncate text-center">
                  {{ doc.file.name|cut:"documents/" }}
                </div>
                <div class="col-span-2 text-center">
                  {{ doc.get_doc_kind_display }}
                </div>
                <div class="col-span-2 text-center">
                  <div class="inline-flex flex-wrap gap-1 justify-center">
                    {% for tag in doc.tags.all %}
                      <span class="bg-button-blue text-primaryDark text-xs font-semibold px-2.5 py-0.5 rounded-full">{{ tag.name }}</span>
                    {% empty %}
                      <span class="text-gray-500">{% trans "Няма тагове" %}</span>
                    {% endfor %}
                  </div>
                </div>
                <div class="col-span-2 flex items-center justify-center gap-3">
                  <a href="{{ doc.file.url }}" target="_blank" class="text-checkmark-green hover:underline" title="{% trans 'Изтегли' %}">
                    <i class="fa-solid fa-download"></i>
                  </a>
                  <a href="{% url 'medj:document_detail' pk=doc.id %}" class="text-button-blue hover:underline" title="{% trans 'Преглед' %}">
                    <i class="fa-solid fa-eye"></i>
                  </a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="px-3 py-4 text-center text-gray-500">
              {% if query %}
                {% blocktrans with hash=query %}Няма документи с хеш {{ hash }}.{% endblocktrans %}
              {% else %}
                {% trans "Все още нямате качени документи." %}
                <a href="{% url 'medj:upload' %}" class="font-bold hover:underline text-button-blue">{% trans "Качете първия си документ от тук" %}</a>.
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</main>

<div id="ob_history" class="hidden fixed inset-0 z-50 bg-black/50 p-4">
  <div class="bg-white rounded-2xl w-full max-w-lg mx-auto p-6">
    <h3 class="text-lg font-semibold text-[var(--color-primaryDark)] mb-2">{% trans "Стъпка 3: История на качванията" %}</h3>
    <p class="text-sm mb-4">{% trans "Тук намирате всички предишни качвания. Използвайте тази страница, за да прегледате, редактирате или експортирате документите." %}</p>
    <div class="flex justify-end gap-3">
      <button id="ob3_ok" class="px-4 py-2 rounded-xl bg-[var(--color-primaryDark)] text-white">{% trans "Разбрах" %}</button>
    </div>
  </div>
</div>

<div id="ob_welcome" class="hidden fixed inset-0 z-50 bg-black/50 p-4">
  <div class="bg-white rounded-2xl w-full max-w-lg mx-auto p-6">
    <h3 class="text-lg font-semibold text-[var(--color-primaryDark)] mb-2">{% trans "Добре дошли!" %}</h3>
    <p class="text-sm mb-4">{% trans "Онбордингът приключи. Вече можете да използвате MedJ пълноценно." %}</p>
    <div class="flex justify-end gap-3">
      <button id="ob4_ok" class="px-4 py-2 rounded-xl bg-[var(--color-primaryDark)] text-white">{% trans "Разбрах" %}</button>
    </div>
  </div>
</div>

<script>
(function(){
  try{
    if(!localStorage.getItem('ob_history_done')){
      document.getElementById('ob_history').classList.remove('hidden');
    }else if(!localStorage.getItem('ob_welcome_done')){
      document.getElementById('ob_welcome').classList.remove('hidden');
    }
    document.getElementById('ob3_ok')?.addEventListener('click', function(){
      localStorage.setItem('ob_history_done','1');
      document.getElementById('ob_history').classList.add('hidden');
      if(!localStorage.getItem('ob_welcome_done')){
        document.getElementById('ob_welcome').classList.remove('hidden');
      }
    });
    document.getElementById('ob4_ok')?.addEventListener('click', function(){
      localStorage.setItem('ob_welcome_done','1');
      document.getElementById('ob_welcome').classList.add('hidden');
    });
  }catch(e){}
})();
</script>
{% endblock %}
