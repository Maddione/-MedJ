{% extends "basetemplates/base_app.html" %}
{% load i18n static %}

{% block title %}{% trans "Качи документ" %}{% endblock %}

{% block app_content %}
<style>
.upload-page select.ui-select,
.upload-page select.ui-select option { color:#0A1E4A !important; }
.upload-page select.ui-select { background:#FFFFF5 !important; -webkit-text-fill-color:#0A1E4A !important; }
.upload-page select.ui-select:disabled { color:rgba(10,30,74,.55) !important; -webkit-text-fill-color:rgba(10,30,74,.55) !important; }
.upload-page select.ui-select option[disabled],
.upload-page select.ui-select option[disabled][selected] { color:#7A7A7A !important; }
.disabled-ui { opacity:.4 !important; pointer-events:none !important; }
</style>

<form id="upload-form" method="post" enctype="multipart/form-data" class="upload-page max-w-8xl mx-auto space-y-8">
  {% csrf_token %}

  <div class="w-full max-w-8xl mx-auto rounded-2xl p-8 mt-16">
    <div class="text-2xl font-bold text-[#0A1E4A] mb-1">{% trans "Качване на документ" %}</div>

    <div class="rounded-2xl p-6 mb-3 flex flex-wrap items-center gap-4" style="background:#3EB2C1; box-shadow:0 6px 14px rgba(10,30,74,.10), inset 0 0 0 1px rgba(10,30,74,.08)">
      <span class="text-2xl font-extrabold text-[#0A1E4A]">{% trans "Пo време на ..." %}</span>

      <select id="sel_category" name="category" class="ui-select h-12 min-w-[220px] rounded-xl px-4 border border-gray-300">
        <option value="" selected disabled>{% trans "Категория" %}</option>
        {% for o in categories %}
          <option value="{{ o.id }}">{{ o.name }}</option>
        {% endfor %}
      </select>

      <span class="text-2xl font-extrabold text-[#0A1E4A]">{% trans ", по " %}</span>

      <select id="sel_specialty" name="specialty" class="ui-select h-12 min-w-[220px] rounded-xl px-4 border border-gray-300 disabled-ui" disabled aria-disabled="true">
        <option value="" selected disabled>{% trans "Специалност" %}</option>
        {% for o in specialties %}
          <option value="{{ o.id }}">{{ o.name }}</option>
        {% endfor %}
      </select>

      <span class="text-2xl font-extrabод text-[#0A1E4A]">{% trans "беше назначено " %}</span>

      <select id="sel_doc_type" name="doc_type" class="ui-select h-12 min-w-[220px] rounded-xl px-4 border border-gray-300 disabled-ui" disabled aria-disabled="true">
        <option value="" selected disabled>{% trans "Вид документ" %}</option>
        {% for o in doc_types %}
          <option value="{{ o.id }}">{{ o.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div id="req_warn" class="hidden rounded-2xl p-4 mb-6 text-white" style="background:#E64E3A">
      <div class="font-semibold mb-2">{% trans "Моля, попълнете липсващите стъпки:" %}</div>
      <ul id="req_list" class="list-disc pl-6 space-y-1"></ul>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="rounded-2xl p-8 text-center" style="background:#FFFFF5; box-shadow:0 6px 14px rgba(10,30,74,.10), inset 0 0 0 1px rgba(10,30,74,.08)">
        <div class="space-y-6">
          <label id="file_btn" for="file_input" class="inline-block px-6 py-3 rounded-xl text-white text-lg font-semibold disabled-ui" style="background:#0A4E75">
            {% trans "Изберете документ за качване" %}
          </label>
          <input id="file_input" name="file" type="file" class="hidden" disabled aria-disabled="true">

          <label class="block">
            <select id="file_kind" name="file_kind" class="ui-select w-full h-12 rounded-xl px-4 border border-gray-300 disabled-ui" disabled aria-disabled="true">
              <option value="" selected disabled>{% trans "Изберете тип файл" %}</option>
              <option value="pdf">PDF</option>
              <option value="image">{% trans "Изображение" %}</option>
              <option value="docx">DOCX</option>
            </select>
          </label>

          <button id="btn_upload" type="submit" class="w-full h-12 rounded-xl text-white text-lg font-semibold disabled-ui" style="background:#7ECAD6" disabled aria-disabled="true">
            {% trans "Качи" %}
          </button>
        </div>
      </div>

      <div class="rounded-2xl p-8" style="background:#FFFFF5; box-shadow:0 6px 14px rgba(10,30,74,.10), inset 0 0 0 1px rgba(10,30,74,.08)">
        <div class="rounded-xl p-3 border border-black/10" style="background:#FFFFF5">
          <div class="text-left text-sm text-[#0A1E4A] font-semibold mb-2">{% trans "Визуализация" %}</div>
          <div id="preview_box" class="w-full max-h-[28rem] overflow-auto rounded-lg border border-black/10 flex items-center justify-center">
            <div id="preview_placeholder" class="text-[#0A1E4A] text-sm opacity-60 py-16 px-4">
              {% trans "Все още няма избран файл. Моля, изпълнете стъпките отляво." %}
            </div>
            <img id="preview_img" class="hidden max-w-full h-auto" alt="preview">
            <object id="preview_pdf" class="hidden w-full h-[28rem]" type="application/pdf" data=""></object>
          </div>
          <div id="preview_meta" class="mt-3 text-xs text-[#0A1E4A]"></div>
        </div>
      </div>
    </div>
  </div>
</form>

<div id="ob_upload" class="hidden fixed inset-0 z-50 bg-black/50 p-4">
  <div class="bg-white/90 rounded-2xl w-full max-w-xl mx-auto p-6" style="border:4px solid #0A4E75">
    <h3 class="text-lg font-semibold text-[#0A1E4A] mb-2">{% trans "Стъпка 2: Качи документ" %}</h3>
    <p class="text-sm mb-4">
      {% trans "Изберете категория, медицинска специалност и вид документ. Качете файла. Ще извлечем текст с OCR, ще го прегледате и одобрите, след което ще получите анализ и резюме. Ако напуснете страницата преди да запазите, няма да има данни за гледане." %}
    </p>
    <div class="flex justify-end gap-3">
      <button id="ob2_ok" class="px-4 py-2 rounded-xl text-white" style="background:#0A4E75">{% trans "Разбрах" %}</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  var form = document.getElementById('upload-form');
  var selCat = document.getElementById('sel_category');
  var selSpec = document.getElementById('sel_specialty');
  var selDoc = document.getElementById('sel_doc_type');
  var fileBtn = document.getElementById('file_btn');
  var fileInput = document.getElementById('file_input');
  var fileKind = document.getElementById('file_kind');
  var btnUpload = document.getElementById('btn_upload');
  var warn = document.getElementById('req_warn');
  var warnList = document.getElementById('req_list');
  var previewPlaceholder = document.getElementById('preview_placeholder');
  var previewImg = document.getElementById('preview_img');
  var previewPdf = document.getElementById('preview_pdf');
  var previewMeta = document.getElementById('preview_meta');

  function hasValue(selectEl){ return !!selectEl && selectEl.selectedIndex > 0; }

  function setDisabled(el, disabled){
    if(!el) return;
    el.disabled = !!disabled;
    el.setAttribute('aria-disabled', disabled ? 'true':'false');
    el.classList.toggle('disabled-ui', !!disabled);
  }

  function setDisabledLabel(labelEl, disabled){
    if(!labelEl) return;
    if(disabled){ labelEl.classList.add('disabled-ui'); labelEl.setAttribute('data-disabled','true'); }
    else { labelEl.classList.remove('disabled-ui'); labelEl.removeAttribute('data-disabled'); }
  }

  function clearPreview(){
    if(previewImg){ previewImg.src = ""; previewImg.classList.add('hidden'); }
    if(previewPdf){ previewPdf.data = ""; previewPdf.classList.add('hidden'); }
    if(previewPlaceholder){ previewPlaceholder.classList.remove('hidden'); }
    if(previewMeta){ previewMeta.textContent = ""; }
  }

  function showRequirements(){
    var missing = [];
    if(!hasValue(selCat)) missing.push("{% trans 'Категория' %}");
    if(!hasValue(selSpec)) missing.push("{% trans 'Специалност' %}");
    if(!hasValue(selDoc)) missing.push("{% trans 'Вид документ' %}");
    if(fileInput.disabled || !fileInput.value) missing.push("{% trans 'Документ за качване' %}");
    if(!hasValue(fileKind)) missing.push("{% trans 'Тип файл' %}");
    warnList.innerHTML = missing.map(function(m){ return "<li>• " + m + "</li>"; }).join("");
    if(missing.length){ warn.classList.remove('hidden'); } else { warn.classList.add('hidden'); }
  }

  function updateStates(){
    var hasCat = hasValue(selCat);
    setDisabled(selSpec, !hasCat);
    if(!hasCat) selSpec.selectedIndex = 0;

    var hasSpec = hasCat && hasValue(selSpec);
    setDisabled(selDoc, !hasSpec);
    if(!hasSpec) selDoc.selectedIndex = 0;

    var hasDocType = hasSpec && hasValue(selDoc);
    if(hasDocType){
      setDisabled(fileInput, false);
      setDisabledLabel(fileBtn, false);
    }else{
      setDisabled(fileInput, true);
      fileInput.value = "";
      setDisabledLabel(fileBtn, true);
      clearPreview();
      setDisabled(fileKind, true);
      fileKind.selectedIndex = 0;
      setDisabled(btnUpload, true);
    }
    showRequirements();
  }

  selCat.addEventListener('change', updateStates);
  selSpec.addEventListener('change', updateStates);
  selDoc.addEventListener('change', updateStates);

  document.addEventListener('click', function(e){
    var el = e.target;
    var blocked = false;
    if(el.closest('#file_btn') && fileBtn.getAttribute('data-disabled') === 'true') blocked = true;
    if(el.tagName === 'SELECT' && (el.disabled || el.getAttribute('aria-disabled') === 'true')) blocked = true;
    if(el.tagName === 'BUTTON' && (el.disabled || el.getAttribute('aria-disabled') === 'true')) blocked = true;
    var parentDisabled = el.closest('.disabled-ui,[data-disabled="true"],[aria-disabled="true"]');
    if(parentDisabled) blocked = true;
    if(blocked){
      e.preventDefault();
      e.stopPropagation();
      showRequirements();
    }
  }, true);

  function renderPreview(file){
    clearPreview();
    if(!file) return;
    var url = URL.createObjectURL(file);
    previewPlaceholder.classList.add('hidden');
    var name = file.name || "";
    var kb = (file.size/1024).toFixed(1);
    previewMeta.textContent = name + " — " + kb + " KB";
    var lower = name.toLowerCase();
    if(file.type === 'application/pdf' || lower.endsWith('.pdf')){
      previewPdf.data = url;
      previewPdf.classList.remove('hidden');
    }else if(file.type.startsWith('image/')){
      previewImg.src = url;
      previewImg.classList.remove('hidden');
    }else{
      var link = document.createElement('a');
      link.href = url; link.target = "_blank";
      link.textContent = "{% trans 'Преглед/Сваляне на файл' %}";
      previewPlaceholder.classList.add('hidden');
      previewPdf.classList.add('hidden');
      previewImg.classList.add('hidden');
      document.getElementById('preview_box').appendChild(link);
    }
  }

  fileInput.addEventListener('change', function(){
    if(fileInput.files && fileInput.files.length){
      setDisabled(fileKind, false);
      renderPreview(fileInput.files[0]);
      setDisabled(btnUpload, true);
    }else{
      setDisabled(fileKind, true);
      fileKind.selectedIndex = 0;
      setDisabled(btnUpload, true);
      clearPreview();
    }
    showRequirements();
  });

  fileKind.addEventListener('change', function(){
    if(hasValue(fileKind) && fileInput.files && fileInput.files.length){
      setDisabled(btnUpload, false);
    }else{
      setDisabled(btnUpload, true);
    }
    showRequirements();
  });

  if(!localStorage.getItem('ob_upload_done')){
    var ob = document.getElementById('ob_upload');
    ob.classList.remove('hidden');
    document.getElementById('ob2_ok').addEventListener('click', function(){
      localStorage.setItem('ob_upload_done','1');
      ob.classList.add('hidden');
    });
  }

  var leavingWarned = false;
  var started = false;
  window.addEventListener('beforeunload', function (e) {
    if(started && !leavingWarned){
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });
  form.addEventListener('change', function(){ started = true; });

  form.addEventListener('submit', function(e){
    e.preventDefault();
    started = true;
    showRequirements();
    if(fileInput.disabled || !fileInput.value || !hasValue(fileKind) || !hasValue(selCat) || !hasValue(selSpec) || !hasValue(selDoc)){
      return;
    }
    var fd = new FormData(form);
    var csrf = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
    fetch("{% url 'medj:upload' %}", {
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrf},
      body: fd
    }).then(r=>r.json()).then(function(j){
      if(j && j.ok){
        leavingWarned = true;
        window.location.href = j.next || "{% url 'medj:upload' %}";
        return;
      }
      warnList.innerHTML = "<li>• " + (j && j.error ? j.error : "{% trans 'Грешка при качване' %}") + "</li>";
      warn.classList.remove('hidden');
    }).catch(function(){
      warnList.innerHTML = "<li>• {% trans 'Грешка при връзката.' %}</li>";
      warn.classList.remove('hidden');
    });
  });

  updateStates();
})();
</script>
{% endblock %}
