{% extends 'basetemplates/base_app.html' %}
{% load i18n %}
{% block content %}
<main class="bg-site-background min-h-screen p-4 md:p-8">
  <div class="container mx-auto max-w-4xl">
    <div class="bg-block-background p-6 rounded-3xl shadow-lg mb-8">
      <h1 class="text-3xl font-bold text-gray-800">{% trans "Качване на документ" %}</h1>
      <p class="mt-2 text-gray-600">{% trans "Изберете специалност и вид документ. По желание изберете лекар и съществуващо събитие." %}</p>
    </div>

    <div class="bg-block-background p-6 rounded-3xl shadow-lg">
      <form method="post" enctype="multipart/form-data" id="upload-form" class="space-y-6">
        {% csrf_token %}

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Специалност" %}</label>
          {{ form.specialty }}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Вид документ" %}</label>
            {{ form.doc_type }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Лекар" %}</label>
            {{ form.practitioner }}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Дата на документа" %}</label>
            {{ form.document_date }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Прикачи към събитие" %}</label>
            {{ form.attach_to_event }}
            <p class="text-sm text-gray-500 mt-1">{% trans "Оставете празно, за да се създаде ново събитие на избраната дата." %}</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Файл" %}</label>
          {{ form.file }}
        </div>

        {% if form.errors %}
          <div class="bg-light-red-bg border border-error-red text-dark-red-text px-4 py-3 rounded-lg">
            {% for field, errors in form.errors.items %}{% for error in errors %}<p>{{ error }}</p>{% endfor %}{% endfor %}
          </div>
        {% endif %}

        <div class="pt-4">
          <button class="px-8 py-4 bg-button-blue text-white font-bold rounded-lg shadow-md hover:bg-navbar-button-blue transition-colors">
            {% trans "Качи" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
document.addEventListener('change', async (e) => {
  if (e.target && e.target.id === 'id_specialty') {
    const specId = e.target.value;
    const url = "{% url 'medj:events_by_specialty' %}" + "?specialty=" + encodeURIComponent(specId);
    const res = await fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}});
    const data = await res.json();
    const select = document.getElementById("id_attach_to_event");
    select.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "";
    select.appendChild(opt);
    data.results.forEach(r => {
      const o = document.createElement("option");
      o.value = r.id;
      o.textContent = `${r.date}${r.summary ? ' — ' + r.summary : ''}`;
      select.appendChild(o);
    });
  }
});
</script>
{% endblock %}
