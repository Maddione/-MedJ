{% extends "basetemplates/base_app.html" %}
{% load i18n %}
{% block title %}{% trans "Споделяне / Експорт" %}{% endblock %}
{% block app_content %}
<main class="max-w-6xl mx-auto grid md:grid-cols-12 gap-6">
  <section class="md:col-span-8 bg-[#FFFFF5] rounded-2xl shadow p-4">
    <h1 class="text-2xl font-bold mb-3" style="color:#0A4E75">{% trans "Филтър" %}</h1>
    <form id="share-filters" class="space-y-4" data-create-links-url="{% url 'medj:create_download_links' %}" data-qr-for-url="{% url 'medj:qr_for_url' %}">
      {% csrf_token %}
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#0A4E75">{% trans "От дата" %}</label>
          <input type="date" name="start_date" class="w-full rounded-lg p-2" style="background:#EAEBDA; color:#0A4E75">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#0A4E75">{% trans "До дата" %}</label>
          <input type="date" name="end_date" class="w-full rounded-lg p-2" style="background:#EAEBDA; color:#0A4E75">
        </div>
      </div>
      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#0A4E75">{% trans "Валидност PDF събития (часове)" %}</label>
          <input type="number" min="1" max="8760" name="hours_events" value="24" class="w-full rounded-lg p-2" style="background:#EAEBDA; color:#0A4E75">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#0A4E75">{% trans "Валидност PDF лаборатории (часове)" %}</label>
          <input type="number" min="1" max="8760" name="hours_labs" value="24" class="w-full rounded-lg p-2" style="background:#EAEBDA; color:#0A4E75">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#0A4E75">{% trans "Валидност CSV (часове)" %}</label>
          <input type="number" min="1" max="8760" name="hours_csv" value="24" class="w-full rounded-lg p-2" style="background:#EAEBDA; color:#0A4E75">
        </div>
      </div>
      <div class="flex items-center gap-6 mt-2">
        <label class="inline-flex items-center gap-2"><input id="generate-events" type="checkbox" class="w-4 h-4" checked><span>{% trans "PDF събития" %}</span></label>
        <label class="inline-flex items-center gap-2"><input id="generate-labs" type="checkbox" class="w-4 h-4" checked><span>{% trans "PDF лаборатории" %}</span></label>
        <label class="inline-flex items-center gap-2"><input id="generate-csv" type="checkbox" class="w-4 h-4" checked><span>CSV</span></label>
      </div>
      <div class="mt-4">
        <button type="button" id="gen-links" class="px-4 py-2 rounded-xl bg-checkgreen text-white">{% trans "Генерирай линкове" %}</button>
      </div>
    </form>
  </section>
  <section class="md:col-span-4 bg-white rounded-2xl shadow p-4">
    <h2 class="text-xl font-semibold mb-3" style="color:#0A4E75">{% trans "Резултат" %}</h2>
    <div class="space-y-3">
      <div>
        <label class="text-sm font-semibold block mb-1">{% trans "PDF събития" %}</label>
        <input id="link-pdf-events" type="text" readonly class="w-full rounded-lg p-2 bg-[#EAEBDA] text-[#0A4E75]">
        <a id="btn-pdf-events" class="inline-block mt-2 px-3 py-1 rounded-lg bg-[#0A4E75] text-white opacity-50 pointer-events-none" target="_blank">{% trans "Отвори" %}</a>
      </div>
      <div>
        <label class="text-sm font-semibold block mb-1">{% trans "PDF лаборатории" %}</label>
        <input id="link-pdf-labs" type="text" readonly class="w-full rounded-lg p-2 bg-[#EAEBDA] text-[#0A4E75]">
        <a id="btn-pdf-labs" class="inline-block mt-2 px-3 py-1 rounded-lg bg-[#0A4E75] text-white opacity-50 pointer-events-none" target="_blank">{% trans "Отвори" %}</a>
      </div>
      <div>
        <label class="text-sm font-semibold block mb-1">CSV</label>
        <input id="link-csv" type="text" readonly class="w-full rounded-lg p-2 bg-[#EAEBDA] text-[#0A4E75]">
        <a id="btn-csv" class="inline-block mt-2 px-3 py-1 rounded-lg bg-[#0A4E75] text-white opacity-50 pointer-events-none" target="_blank">{% trans "Отвори" %}</a>
      </div>
      <div class="mt-4">
        <img id="qr-img" class="w-48 h-48 border rounded-lg" alt="">
      </div>
    </div>
  </section>
</main>
{% endblock %}
{% block scripts_extra %}
{% load static %}
<script>
(function(){
  function getCSRF(){var i=document.querySelector('input[name="csrfmiddlewaretoken"]');return i?i.value:''}
  var form=document.getElementById('share-filters');
  if(!form) return;
  var createUrl=form.dataset.createLinksUrl.trim();
  var qrUrl=form.dataset.qrForUrl.trim();
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    var fd=new FormData(form);
    var payload=Object.fromEntries(fd.entries());
    var res=await fetch(createUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},
      credentials:'same-origin',
      body:JSON.stringify(payload)
    });
    if(!res.ok) return;
    var data=await res.json();
    if(data && data.download_url){
      var q=await fetch(qrUrl, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},
        credentials:'same-origin',
        body:JSON.stringify({url:data.download_url})
      });
      if(q.ok){
        var blob=await q.blob();
        var imgURL=URL.createObjectURL(blob);
        var img=document.getElementById('qrPreview');
        if(img){img.src=imgURL}
      }
    }
  });
})();
</script>

{% endblock %}
