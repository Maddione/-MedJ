{% extends "basetemplates/base_app.html" %}
{% load i18n widget_tweaks static %}

{% block title %}{% trans "Лична здравна карта" %}{% endblock %}

{% block app_content %}
{% trans "Собствено" as ph_first %}
{% trans "Презиме" as ph_middle %}
{% trans "Фамилия" as ph_last %}
<form method="post" id="personalcard-form" class="relative max-w-7xl mx-auto space-y-6">
  {% csrf_token %}

  <div class="rounded-2xl p-5" style="background:#FFFFF5;box-shadow:0 10px 14px rgba(10,30,74,.10),inset 0 0 0 1px rgba(10,30,74,.08)">
    <div class="text-2xl font-bold text-[var(--color-primaryDark)] mb-4">{% trans "Основна информация" %}</div>

    <div class="grid grid-cols-1 gap-4">
      <div class="rounded-2xl p-4 md:p-6" style="background:#EBEDE0">
        <div class="grid grid-cols-12 gap-4 items-start">
          <div class="col-span-12 md:col-span-7">
            <div class="text-xl md:text-2xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Име" %}</div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              {% render_field profile_form.first_name_bg class+="h-12 rounded-xl px-4 border-0 bg-white text-[var(--color-primaryDark)] text-lg font-semibold" placeholder=ph_first %}
              {% render_field profile_form.middle_name_bg class+="h-12 rounded-xl px-4 border-0 bg-white text-[var(--color-primaryDark)] text-lg font-semibold" placeholder=ph_middle %}
              {% render_field profile_form.last_name_bg class+="h-12 rounded-xl px-4 border-0 bg-white text-[var(--color-primaryDark)] text-lg font-semibold" placeholder=ph_last %}
            </div>
          </div>
          <div class="col-span-12 md:col-span-5 grid grid-cols-2 gap-4">
            <div>
              <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Години" %}</div>
              <div id="pc_age" class="h-12 flex items-center rounded-xl px-4 bg-white text-[var(--color-primaryDark)] text-lg font-semibold">—</div>
              <div class="mt-2">
                <label class="text-sm text-[var(--color-primaryDark)] opacity-80 mb-1 block">{% trans "Дата на раждане" %}</label>
                {% render_field profile_form.date_of_birth class+="h-11 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" type="date" %}
              </div>
            </div>
            <div>
              <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Пол" %}</div>
              {% render_field profile_form.sex class+="h-12 rounded-xl px-4 border-0 bg-white text-[var(--color-primaryDark)] text-lg font-semibold" %}
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        <div class="lg:col-span-8 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="rounded-2xl p-4" style="background:#EBEDE0">
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Височина" %}</div>
            <input name="height_cm" class="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" placeholder="— см">
          </div>
          <div class="rounded-2xl p-4" style="background:#EBEDE0">
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Тегло" %}</div>
            <input name="weight_kg" class="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" placeholder="— кг">
          </div>
          <div class="rounded-2xl p-4" style="background:#EBEDE0">
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Кръвна група" %}</div>
            {% render_field profile_form.blood_type class+="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" %}
          </div>
        </div>
        <div class="lg:col-span-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-4">
          <div class="rounded-2xl p-4" style="background:#EBEDE0">
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Телефон" %}</div>
            {% render_field profile_form.phone class+="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" %}
          </div>
          <div class="rounded-2xl p-4" style="background:#EBEDE0">
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Адрес" %}</div>
            {% render_field profile_form.address class+="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" %}
          </div>
        </div>
      </div>

      <div class="rounded-2xl p-4 md:p-6" style="background:#EBEDE0">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Общопрактикуващ лекар" %}</div>
            <input name="gp_name" class="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" placeholder="—">
          </div>
          <div>
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Телефон" %}</div>
            <input name="gp_phone" class="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" placeholder="—">
          </div>
          <div>
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "Адрес" %}</div>
            <input name="gp_address" class="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" placeholder="—">
          </div>
          <div>
            <div class="text-xl font-bold text-[var(--color-primaryDark)] mb-2">{% trans "РЗОК" %}</div>
            <input name="insurer" class="h-12 w-full rounded-xl px-4 bg-white border-0 text-[var(--color-primaryDark)]" placeholder="—">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-end">
    <button type="submit" class="px-6 h-12 rounded-xl text-white font-semibold" style="background:#15BC11">{% trans "Запази" %}</button>
  </div>

  <button type="button" id="openShareModal" class="fixed bottom-6 right-6 h-24 w-24 rounded-full shadow-xl flex items-center justify-center" style="background:#E64D3D">
    <img src="{% static 'images/qr-white.svg' %}" alt="qr" class="h-10 w-10">
  </button>
</form>

<div id="ob_personalcard" class="hidden fixed inset-0 z-50 bg-black/50 p-4">
  <div class="bg-white/90 rounded-2xl w-full max-w-xl mx-auto p-6" style="border:4px solid #0A4E75">
    <h3 class="text-lg font-semibold text-[#0A1E4A] mb-2">{% trans "Стъпка 1: Лична карта" %}</h3>
    <p class="text-sm mb-4">{% trans "Въведете име, фамилия и дата на раждане. Полетата със * са задължителни. Натиснете „Запази“, след което „Разбрах“." %}</p>
    <div class="flex justify-end gap-3"><button id="ob1_ok" class="px-4 py-2 rounded-xl text-white" style="background:#0A4E75">{% trans "Разбрах" %}</button></div>
  </div>
</div>

<div id="shareModal" class="hidden fixed inset-0 z-50 bg-black/60 items-center justify-center p-4">
  <div class="bg-white rounded-2xl w-full max-w-lg mx-auto p-6 shadow-xl" id="shareModalContent">
    <h3 class="text-xl font-semibold text-primaryDark mb-4">{% trans "Споделяне на лична карта" %}</h3>
    <div id="shareLoader" class="hidden text-center py-8">{% trans "Генериране..." %}</div>
    <div id="shareError" class="hidden p-3 rounded-lg bg-red-50 text-red-700"></div>
    <div id="shareDetails" class="space-y-4">
      <div>
        <label for="shareLink" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Публичен линк" %}</label>
        <div class="flex gap-2">
          <input id="shareLink" type="text" readonly class="w-full rounded-lg p-2 bg-sitebg border-gray-300 text-primaryDark">
          <button id="copyShareLink" class="px-3 py-2 rounded-lg font-semibold text-white" style="background:#0A4E75">{% trans "Копирай" %}</button>
        </div>
      </div>
      <div class="flex items-center justify-center"><div id="qrCodeContainer" class="p-2 border rounded-lg bg-gray-50"></div></div>
      <div class="flex items-center justify-end gap-3 mt-6"><button id="closeShareModal" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-800 hover:bg-gray-300">{% trans "Затвори" %}</button></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
{{ block.super }}
<script>
(function(){
  function computeAge(v){
    if(!v) return "—";
    var d=new Date(v); if(isNaN(d)) return "—";
    var t=new Date(); var a=t.getFullYear()-d.getFullYear();
    var m=t.getMonth()-d.getMonth(); if(m<0||(m===0&&t.getDate()<d.getDate())) a--;
    return a>0?(a+" г."):"—";
  }
  function updateAge(){
    var dob=document.getElementById("id_date_of_birth");
    var out=document.getElementById("pc_age");
    if(dob&&out){ out.textContent=computeAge(dob.value); }
  }
  document.addEventListener("input",function(e){ if(e.target && e.target.id==="id_date_of_birth") updateAge(); });
  updateAge();
})();
document.addEventListener('DOMContentLoaded', function() {
  const openBtn = document.getElementById('openShareModal');
  const closeBtn = document.getElementById('closeShareModal');
  const modal = document.getElementById('shareModal');
  const copyBtn = document.getElementById('copyShareLink');
  const linkEl = document.getElementById('shareLink');
  const qrContainer = document.getElementById('qrCodeContainer');
  const loader = document.getElementById('shareLoader');
  const errorEl = document.getElementById('shareError');
  const shareDetails = document.getElementById('shareDetails');
  function getCSRFToken(){const el=document.querySelector('input[name="csrfmiddlewaretoken"]');return el?el.value:"";}
  async function openShareModal(){
    if(!modal) return;
    modal.classList.remove('hidden'); modal.classList.add('flex');
    shareDetails.classList.add('hidden'); errorEl.classList.add('hidden'); loader.classList.remove('hidden');
    try{
      const res=await fetch("{% url 'medj:personalcard_share_enable_api' %}",{method:'POST',headers:{'X-CSRFToken':getCSRFToken(),'X-Requested-With':'XMLHttpRequest','Content-Type':'application/json'},body:JSON.stringify({enable:true})});
      if(!res.ok) throw new Error();
      const data=await res.json();
      if(data.url && data.qr_code_svg){ linkEl.value=data.url; qrContainer.innerHTML=data.qr_code_svg; shareDetails.classList.remove('hidden'); } else { throw new Error(); }
    }catch(e){ errorEl.textContent="{% trans 'Възникна грешка при генерирането на линк. Моля, опитайте отново.' %}"; errorEl.classList.remove('hidden'); }
    finally{ loader.classList.add('hidden'); }
  }
  function closeShareModal(){ if(modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); } }
  if(openBtn) openBtn.addEventListener('click', openShareModal);
  if(closeBtn) closeBtn.addEventListener('click', closeShareModal);
  if(modal) modal.addEventListener('click', e => { if(e.target===modal) closeShareModal(); });
  if(copyBtn && linkEl){ copyBtn.addEventListener('click', function(){ linkEl.select(); document.execCommand('copy'); copyBtn.textContent="{% trans 'Копирано!' %}"; setTimeout(()=>copyBtn.textContent="{% trans 'Копирай' %}",2000); }); }
});
</script>
{% endblock %}
