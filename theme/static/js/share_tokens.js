async function j(u,o){const r=await fetch(u,o||{credentials:"same-origin"});if(!r.ok)throw new Error("bad");return await r.json()}
function c(it){const s=it.status||"";const e=it.expires_at||"";const u=it.url||"#";return '<div class="p-4 rounded-xl" style="background:#FFFFF5; box-shadow: 0 10px 14px rgba(10,30,74,.08);"><div class="flex items-center justify-between"><div class="text-[#0A1E4A] font-semibold">'+it.object_type+" #"+it.object_id+'</div><div class="text-sm">'+s+" · "+e+'</div></div><div class="mt-2 break-all"><a href="'+u+'" class="underline" target="_blank">'+u+'</a></div><div class="mt-3 flex gap-2"><button data-token="'+it.token+'" class="btn-revoke px-3 h-10 rounded-lg text-white" style="background:#D84137">Отмени</button></div></div>'}
function t(){const i=document.querySelector('input[name="csrfmiddlewaretoken"]');if(i)return i.value;const m=document.cookie.match(/csrftoken=([^;]+)/);return m?m[1]:""}
async function loadHistory(){const L=document.getElementById("shareList");if(!L)return;try{const d=await j("/api/share/history/");const a=d.results||[];L.innerHTML=a.map(c).join("")||'<div class="text-[#0A1E4A] opacity-70">Няма споделяния.</div>';document.querySelectorAll(".btn-revoke").forEach(b=>{b.addEventListener("click",async()=>{const k=b.getAttribute("data-token");try{await j("/api/share/revoke/"+encodeURIComponent(k)+"/",{method:"POST",headers:{"X-CSRFToken":t()},credentials:"same-origin"});loadHistory()}catch(e){}})})}catch(e){L.innerHTML='<div class="text-[#0A1E4A] opacity-70">Грешка при зареждане.</div>'}}
document.addEventListener("DOMContentLoaded",()=>{loadHistory()})
